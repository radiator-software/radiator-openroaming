# radiator-radsec_inbound_local_clients.conf
# for inbound RadSec connections for local clients
# 
# Copyright by Radiator Software 2020-2025
# Created: 2022-02-16 kh@radiatorsoftware.com
# Modified: 2025-01-23 kh@radiatorsoftware.com

# Radiator directories
DbDir	/etc/radiator
LogDir	/var/log/radiator
LogFile	%L/radiator-%{GlobalVar:instance}.log

# more detailed logging
LogMicroseconds
LogTraceId
Trace 2

# return only minimal information with Status-Server
StatusServer minimal

# Proxy also unknown attributes
ProxyUnknownAttributes

# Needed only for Radiator <= v4.28, an example how to use custom dictionaries
#DictionaryFile /opt/radiator/radiator/dictionary,/etc/radiator/dictionary.wba

# Dictionary file
DictionaryFile /opt/radiator/radiator/dictionary

# No pidfile is needed when started as a systemd service
PidFile

# Make IPv6 and IPv4 listen sockets completely separate
# Bind only to IPv4 wildcard address
BindV6Only
BindAddress	0.0.0.0

# this instance does not listen any RADIUS ports
AuthPort
AcctPort

# authentication log to file
<AuthLog FILE>

	Identifier AUTHLOG-FILE
	
	Filename %L/authentication-%{GlobalVar:instance}.log

	Include %D/conf.d/authlog-formats.conf

	LogSuccess
	LogFailure
	LogIgnore

</AuthLog>

# accounting log to file
<AcctLog FILE>

	Identifier ACCTLOG-FILE

	Filename %L/accounting-%{GlobalVar:instance}.log

	Include %D/conf.d/acctlog-formats.conf

</AcctLog>


#
# Clients
#

# RadSec clients are identified by their client certificates
# configured in the ServerRADSEC section.

#
# Servers
#

# RadSec server configuration
<ServerRADSEC>

	Identifier SERVER-RADSEC
	
	# a separate port is used for incoming local clients Radsec
	# connections
	Port 3802
	Secret radsec
	Protocol tcp

	# These TLS settings are left liberal for interoperability.
	# They can be hardened, but functionality and interoperability with other
	# implementations need to tested in practice.
	TLS_SecurityLevel 1
	TLS_Protocols TLSv1,TLSv1.1,TLSv1.2,TLSv1.3

	TLS_CertificateType PEM
	# TLS_CAPath is a directory which contains all CAs, which are allowed
	# to verify local RadSec client certificates
	TLS_CAPath %D/certificates/%{GlobalVar:instance}/ca/
	# TLS_CertificateChainFile is the RadSec server certificate with 
	# possible intermediate CA certificates combined with it
	TLS_CertificateChainFile %D/certificates/%{GlobalVar:instance}/server/CertificateChainFile.pem
	# TLS_PrivateKeyFile is the private key file of the server certificate
	TLS_PrivateKeyFile %D/certificates/%{GlobalVar:instance}/server/PrivateKeyFile.pem
	# TLS_RequireClientCert accepts only connections with valid CA 
	# certificates
	TLS_RequireClientCert

	# Strip vendor specific RADIUS attributes from the request
        Include /etc/radiator/conf.d/strip-osc-attributes.conf

        # Add to RADIUS request a vendor specific attribute, which contains
        # instance name, radsec client indentifier and radsec client ip address
        #AddToRequestIfNotExist OSC-Client-Identifier=%{GlobalVar:instance}/%{Client:Identifier}/%c

        # Add to RADIUS request information about the client from the request was received
        # %c is client IP address
        AddToRequestIfNotExists	OSC-Client-Identifier=CLIENT-RADSEC-INBOUND-LOCAL-CLIENTS,\
                        	OSC-Service-Identifier=%{GlobalVar:instance},\
                        	OSC-Customer-Identifier=LOCAL

</ServerRADSEC>


#
# AuthBy authentication backends
#

# proxy to RADIUS roaming logic
<AuthBy RADIUS>
	Identifier AUTHBY-RADIUS-PROXY
	Secret mysecret
	Asynchronous
	UseExtendedIds
	Retries 1
	RetryTimeout 3
	# never mark a local RADIUS server instance dead
	FailureBackoffTime 0
	Host 127.0.0.1
	AuthPort 1812
	AcctPort 1813
</AuthBy>


#
# Handlers for AAA requests
#

# requests with realms are forwarded to local RADIUS proxy
<Handler Realm=/.+/>

	Identifier HANDLER-FORWARD-TO-RADIUS-PROXY

	AuthBy AUTHBY-RADIUS-PROXY
	
	AuthLog AUTHLOG-FILE
	AcctLog ACCTLOG-FILE

</Handler>


# Default handler rejects authentication, accepts accounting
<Handler>
        Identifier HANDLER-DEFAULT
        <AuthBy INTERNAL>
                Identifier HANDLER-DEFAULT
                AuthResult REJECT
                AcctResult ACCEPT
                RejectReason HANDLER-DEFAULT: No matching handler found.
        </AuthBy>
        RejectHasReason
        AuthLog AUTHLOG-FILE
        AcctLog ACCTLOG-FILE
</Handler>

